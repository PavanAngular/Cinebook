<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>CineBook - Movie Booking</title>
Â  <style>
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  background-color: #121212;
Â  Â  Â  color: white;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  min-height: 100vh;
Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  header {
Â  Â  Â  margin: 2rem;
Â  Â  Â  font-size: 2rem;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 1rem;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 700px;
Â  Â  Â  justify-content: space-between;
Â  Â  }
Â  Â  header h1 {
Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  gap: 1rem;
Â  Â  }
Â  Â  .user-actions {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 1rem;
Â  Â  Â  Â  align-items: center;
Â  Â  }
Â  Â  .user-actions span {
Â  Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  Â  color: #bbb;
Â  Â  }
Â  Â  .container {
Â  Â  Â  background-color: #1e1e1e;
Â  Â  Â  padding: 2rem;
Â  Â  Â  border-radius: 1rem;
Â  Â  Â  min-width: 300px;
Â  Â  Â  width: 90%;
Â  Â  Â  max-width: 700px;
Â  Â  Â  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
Â  Â  Â  margin-top: 2rem;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  .section-title {
Â  Â  Â  font-size: 1.8rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  Â  text-align: center;
Â  Â  Â  color: #6c63ff;
Â  Â  }
Â  Â Â 
Â  Â  .btn-grid {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 0.7rem;Â 
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  }
Â  Â  .btn {
Â  Â  Â  padding: 8px 15px;Â 
Â  Â  Â  border: 1px solid #333;Â 
Â  Â  Â  border-radius: 5px;Â 
Â  Â  Â  font-size: 16px;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: background 0.3s ease, transform 0.2s ease;
Â  Â  Â  min-width: 40px;Â 
Â  Â  Â  text-align: center;
Â  Â  Â  color: #ccc;Â 
Â  Â  Â  background-color: #222;Â 
Â  Â  }
Â  Â  .btn:hover {
Â  Â  Â  transform: translateY(-2px);
Â  Â  }
Â  Â  .btn.selected-seat {
Â  Â  Â  background-color: yellow;
Â  Â  Â  color: #121212;
Â  Â  Â  border-color: gold;
Â  Â  }
Â  Â  .btn.booked-seat {
Â  Â  Â  background-color: black;
Â  Â  Â  color: #999;
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  border-color: #111;
Â  Â  }
Â  Â  .btn.pending-seat {
Â  Â  Â  background-color: orange;
Â  Â  Â  color: #121212;
Â  Â  Â  cursor: not-allowed;
Â  Â  Â  border-color: #885a00;
Â  Â  }
Â  Â  .btn:disabled {
Â  Â  Â  opacity: 0.6;
Â  Â  Â  cursor: not-allowed;
Â  Â  }
Â  Â Â 
Â  Â  .color-key {
Â  Â  Â  display: flex;
Â  Â  Â  justify-content: center;
Â  Â  Â  gap: 1.5rem;Â 
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  font-size: 0.9rem;
Â  Â  Â  padding: 10px;
Â  Â  Â  background-color: #2a2a2a;
Â  Â  Â  border-radius: 8px;
Â  Â  }
Â  Â  .key-item {
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  gap: 0.5rem;Â 
Â  Â  }
Â  Â  .key-color {
Â  Â  Â  width: 20px;
Â  Â  Â  height: 20px;
Â  Â  Â  border-radius: 4px;
Â  Â  Â  border: 1px solid #333;
Â  Â  Â  box-shadow: inset 0 0 3px rgba(0,0,0,0.3);
Â  Â  }
Â  Â  .available-key { background-color: #222; }
Â  Â  .selected-key { background-color: yellow; }
Â  Â  .booked-key { background-color: black; }
Â  Â  .pending-key { background-color: orange; }

Â  Â  .btn.back-btn {
Â  Â  Â  Â  background-color: #555;
Â  Â  Â  Â  margin-top: 1rem;
Â  Â  }
Â  Â  .btn.back-btn:hover {
Â  Â  Â  Â  background-color: #444;
Â  Â  }

Â  Â  /* --- Sections display control --- */
Â  Â  #auth-section, #theatre-selection, #movie-list, #screen-list, #seat-selection, #payment-section, #confirmation, #booking-history {
Â  Â  Â  display: none;
Â  Â  }
Â  Â  #overview-section {
Â  Â  Â  text-align: center;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  #overview-section p {
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  line-height: 1.6;
Â  Â  Â  max-width: 600px;
Â  Â  Â  margin: 1rem auto;
Â  Â  }
Â  Â  .movie-card {
Â  Â  Â  background-color: #2a2a2a;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  overflow: hidden;
Â  Â  Â  display: flex;
Â  Â  Â  flex-direction: column;
Â  Â  Â  align-items: center;
Â  Â  Â  padding: 1rem;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.2s ease, box-shadow 0.2s ease;
Â  Â  Â  width: 180px;Â 
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  .movie-card:hover {
Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
Â  Â  }
Â  Â  .movie-card img {
Â  Â  Â  width: 150px;
Â  Â  Â  height: 225px;
Â  Â  Â  object-fit: cover;
Â  Â  Â  border-radius: 5px;
Â  Â  Â  margin-bottom: 0.8rem;
Â  Â  }
Â  Â  .movie-card h3 {
Â  Â  Â  font-size: 1.1rem;
Â  Â  Â  margin: 0;
Â  Â  Â  white-space: nowrap;
Â  Â  Â  overflow: hidden;
Â  Â  Â  text-overflow: ellipsis;
Â  Â  Â  width: 100%;
Â  Â  }
Â  Â  #movie-grid {
Â  Â  Â  display: grid;
Â  Â  Â  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
Â  Â  Â  gap: 1.5rem;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  #total-amount-display {
Â  Â  Â  font-size: 1.3rem;
Â  Â  Â  font-weight: bold;
Â  Â  Â  margin-bottom: 1.5rem;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  #confirmation #booking-details {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  justify-content: space-around;
Â  Â  Â  align-items: flex-start;
Â  Â  Â  gap: 2rem;
Â  Â  Â  padding: 1.5rem;
Â  Â  Â  background-color: #2a2a2a;
Â  Â  Â  border-radius: 10px;
Â  Â  Â  margin-top: 1.5rem;
Â  Â  }
Â  Â  #confirmation .movie-poster-details {
Â  Â  Â  flex: 1;
Â  Â  Â  min-width: 200px;
Â  Â  Â  text-align: center;
Â  Â  }
Â  Â  #confirmation .movie-poster-details img {
Â  Â  Â  width: 180px;
Â  Â  Â  height: 270px;
Â  Â  Â  object-fit: cover;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-bottom: 1rem;
Â  Â  }
Â  Â  #confirmation .booking-text-details {
Â  Â  Â  flex: 2;
Â  Â  Â  min-width: 250px;
Â  Â  Â  text-align: left;
Â  Â  }
Â  Â  #confirmation .booking-text-details p {
Â  Â  Â  margin: 0.7rem 0;
Â  Â  Â  font-size: 1.1rem;
Â  Â  }
Â  Â  #confirmation .booking-text-details strong {
Â  Â  Â  color: #6c63ff;
Â  Â  }

Â  Â  /* --- Auth Section Specific Styles - MADE BIGGER --- */
Â  Â  #auth-section {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  min-height: 400px;
Â  Â  Â  Â  padding: 3rem;
Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  background-color: #1e1e1e;
Â  Â  Â  Â  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
Â  Â  Â  Â  max-width: 450px;
Â  Â  Â  Â  width: 90%;
Â  Â  Â  Â  margin: 2rem auto;
Â  Â  }
Â  Â  #auth-section .section-title {
Â  Â  Â  Â  margin-bottom: 2rem;
Â  Â  }
Â  Â  #auth-section form {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  gap: 1.2rem;
Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  justify-content: center;
Â  Â  }
Â  Â  #auth-section input[type="email"],
Â  Â  #auth-section input[type="password"],
Â  Â  #auth-section input[type="text"] {
Â  Â  Â  Â  padding: 12px;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  border: 1px solid #555;
Â  Â  Â  Â  background-color: #333;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-size: 1.1rem;
Â  Â  }
Â  Â  #auth-section button {
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  font-size: 1.2rem;
Â  Â  Â  Â  background-color: #6c63ff;
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  border: none;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  transition: background 0.3s;
Â  Â  }
Â  Â  #auth-section button:hover {
Â  Â  Â  Â  background-color: #5548c8;
Â  Â  }
Â  Â  #auth-section p.switch-auth-mode {
Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  margin-top: 2rem;
Â  Â  Â  Â  font-size: 1rem;
Â  Â  }
Â  Â  #auth-section p.switch-auth-mode a {
Â  Â  Â  Â  color: #6c63ff;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  text-decoration: underline;
Â  Â  }

Â  Â  /* --- Booking History Styles --- */
Â  Â  .booking-item {
Â  Â  Â  Â  background-color: #2a2a2a;
Â  Â  Â  Â  padding: 1rem;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  gap: 1rem;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  }
Â  Â  .booking-item .booking-poster {
Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  width: 100px;
Â  Â  Â  Â  height: 150px;
Â  Â  Â  Â  object-fit: cover;
Â  Â  Â  Â  border-radius: 4px;
Â  Â  }
Â  Â  .booking-item .booking-details-text {
Â  Â  Â  Â  flex-grow: 1;
Â  Â  }
Â  Â  .booking-item h3 {
Â  Â  Â  Â  margin-top: 0;
Â  Â  Â  Â  color: #6c63ff;
Â  Â  }
Â  Â  .booking-item p {
Â  Â  Â  Â  margin: 0.3rem 0;
Â  Â  Â  Â  font-size: 0.95rem;
Â  Â  }

Â  </style>
</head>
<body>
Â  <header>
Â  Â  <h1>
Â  Â  Â  <span>ðŸŽ¬</span>
Â  Â  Â  CineBook
Â  Â  </h1>
Â  Â  <div class="user-actions">
Â  Â  Â  <span id="user-display">Not logged in</span>
Â  Â  Â  <button id="my-bookings-btn" class="btn" style="display:none;" onclick="showBookingHistory()">My Bookings</button>
Â  Â  Â  <button id="logout-btn" class="btn" style="display:none;" onclick="logoutUser()">Logout</button>
Â  Â  </div>
Â  </header>

Â  <div class="container">
Â  Â  <div id="auth-section">
Â  Â  Â  <div class="section-title" id="auth-title">Login</div>
Â  Â  Â  <form id="auth-form">
Â  Â  Â  Â  <input type="text" id="auth-name" placeholder="Name" style="display:none;">
Â  Â  Â  Â  <input type="email" id="auth-email" placeholder="Email" required>
Â  Â  Â  Â  <input type="password" id="auth-password" placeholder="Password" required>
Â  Â  Â  Â  <button type="submit" id="auth-submit-btn">Login</button>
Â  Â  Â  </form>
Â  Â  Â  <p class="switch-auth-mode">
Â  Â  Â  Â  Don't have an account? <a href="#" id="switch-to-signup">Sign Up</a>
Â  Â  Â  </p>
Â  Â  </div>

Â  Â  <div id="city-section">
Â  Â  Â  <div class="section-title">Select Your City</div>
Â  Â  Â  <div id="overview-section">
Â  Â  Â  Â  <p>Welcome to CineBook! Your ultimate destination for booking movie tickets with ease. Select your city to begin your cinematic journey.</p>
Â  Â  Â  </div>
Â  Â  Â  <div id="city-list" class="btn-grid"></div>
Â  Â  </div>

Â  Â  <div id="movie-list">
Â  Â  Â  <div class="section-title">Movies Playing Now</div>
Â  Â  Â  <div id="movie-grid"></div>
Â  Â  Â  <button class="btn back-btn" onclick="showCities()">Back to Cities</button>
Â  Â  </div>

Â  Â  <div id="theatre-selection">
Â  Â  Â  <div class="section-title">Select Theatre</div>
Â  Â  Â  <div id="theatre-buttons" class="btn-grid"></div>
Â  Â  Â  <button class="btn back-btn" onclick="fetchMovies(selectedCityDocRef)">Back to Movies</button>
Â  Â  </div>

Â  Â  <div id="screen-list">
Â  Â  Â  <div class="section-title">Select Screen & Time</div>
Â  Â  Â  <div id="screen-buttons" class="btn-grid"></div>
Â  Â  Â  <button class="btn back-btn" onclick="fetchTheatres(selectedMovieDocRef)">Back to Theatres</button>
Â  Â  </div>

Â  Â  <div id="seat-selection">
Â  Â  Â  <div class="section-title">Select Your Seats</div>
Â  Â  Â  <div class="color-key">
Â  Â  Â  Â  <div class="key-item"><span class="key-color available-key"></span> Available</div>
Â  Â  Â  Â  <div class="key-item"><span class="key-color selected-key"></span> Selected</div>
Â  Â  Â  Â  <div class="key-item"><span class="key-color booked-key"></span> Booked</div>
Â  Â  Â  Â  <div class="key-item"><span class="key-color pending-key"></span> Pending</div>
Â  Â  Â  </div>
Â  Â  Â  <div id="seat-buttons" class="btn-grid"></div>
Â  Â  Â  <p id="total-amount-display">Total Amount: â‚¹<span>0</span></p>
Â  Â  Â  <button class="btn" onclick="goToPayment()">Proceed to Payment</button>
Â  Â  Â  <button class="btn back-btn" onclick="fetchShowtimes(selectedTheatreDocRef, selectedMovieDocRef)">Back to Screen & Time</button>
Â  Â  </div>

Â  Â  <div id="payment-section">
Â  Â  Â  <div class="section-title">Payment Details</div>
Â  Â  Â  <p id="payment-total-amount">Total Amount: â‚¹<span>0</span></p>
Â  Â  Â  <button class="btn" onclick="confirmBooking()">Confirm Booking</button>
Â  Â  Â  <button class="btn back-btn" onclick="selectScreen(selectedShowtimeDoc)">Back to Seat Selection</button>
Â  Â  </div>

Â  Â  <div id="confirmation">
Â  Â  Â  <div class="section-title">Booking Confirmed!</div>
Â  Â  Â  <div id="booking-details">
Â  Â  Â  Â  </div>
Â  Â  Â  <button class="btn" onclick="resetBooking()">Book Another Ticket</button>
Â  Â  Â  <button class="btn back-btn" onclick="showBookingHistory()">View All Bookings</button>
Â  Â  </div>

Â  Â  <div id="booking-history">
Â  Â  Â  Â  <div class="section-title">Your Booking History</div>
Â  Â  Â  Â  <div id="booking-history-list">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button class="btn back-btn" onclick="showCities()">Back to Home</button>
Â  Â  </div>

Â  </div>

Â  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script> 
Â  <script>
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAnPt8bt-xGX9VeeaigsgA47MQkeu1cKgQ",
Â  Â  Â  authDomain: "cine-book-booking-system.firebaseapp.com",
Â  Â  Â  projectId: "cine-book-booking-system",
Â  Â  Â  storageBucket: "cine-book-booking-system.firebasestorage.app",
Â  Â  Â  messagingSenderId: "906226887869",
Â  Â  Â  appId: "1:906226887869:web:40c1298a8b096193f39bd4",
Â  Â  Â  measurementId: "G-NTDW96MK9D"
Â  Â  };

Â  Â  let db;
Â  Â  let auth;
Â  Â  let currentUser = null;

Â  Â  try {
Â  Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  Â  db = firebase.firestore();
Â  Â  Â  auth = firebase.auth();
Â  Â  Â  console.log("Firebase initialized successfully!");
Â  Â  } catch (error) {
Â  Â  Â  console.error("Firebase initialization failed:", error);
Â  Â  Â  console.error("Please ensure your firebaseConfig is correct and all Firebase SDK scripts are loaded.");
Â  Â  Â  document.getElementById("city-list").innerHTML = "<p style='color:red;'>Error initializing Firebase. Please check console for details and config.</p>";
Â  Â  }

Â  Â  auth.onAuthStateChanged(user => {
Â  Â  Â  currentUser = user;
Â  Â  Â  const userDisplay = document.getElementById('user-display');
Â  Â  Â  const myBookingsBtn = document.getElementById('my-bookings-btn');
Â  Â  Â  const logoutBtn = document.getElementById('logout-btn');

Â  Â  Â  if (user) {
Â  Â  Â  Â  userDisplay.textContent = `Logged in as: ${user.displayName || user.email}`;
Â  Â  Â  Â  myBookingsBtn.style.display = 'inline-block';
Â  Â  Â  Â  logoutBtn.style.display = 'inline-block';
Â  Â  Â  Â  showCities();
Â  Â  Â  } else {
Â  Â  Â  Â  userDisplay.textContent = 'Not logged in';
Â  Â  Â  Â  myBookingsBtn.style.display = 'none';
Â  Â  Â  Â  logoutBtn.style.display = 'none';
Â  Â  Â  Â  showLoginSignup();
Â  Â  Â  }
Â  Â  Â  console.log("Auth state changed. Current user:", user ? (user.displayName || user.email) : "none");
Â  Â  });


Â  Â  let selectedCityDocRef = null;
Â  Â  let selectedMovieDocRef = null;
Â  Â  let selectedTheatreDocRef = null;
Â  Â  let selectedShowtimeDoc = null;
Â  Â  let selectedSeats = [];

Â  Â  const seatPrice = 150;

Â  Â  function hideAllSections() {
Â  Â  Â  document.getElementById("auth-section").style.display = "none";
Â  Â  Â  document.getElementById("city-section").style.display = "none";
Â  Â  Â  document.getElementById("movie-list").style.display = "none";
Â  Â  Â  document.getElementById("theatre-selection").style.display = "none";
Â  Â  Â  document.getElementById("screen-list").style.display = "none";
Â  Â  Â  document.getElementById("seat-selection").style.display = "none";
Â  Â  Â  document.getElementById("payment-section").style.display = "none";
Â  Â  Â  document.getElementById("confirmation").style.display = "none";
Â  Â  Â  document.getElementById("booking-history").style.display = "none";
Â  Â  }

Â  Â  const authForm = document.getElementById('auth-form');
Â  Â  const authNameInput = document.getElementById('auth-name');
Â  Â  const authEmailInput = document.getElementById('auth-email');
Â  Â  const authPasswordInput = document.getElementById('auth-password');
Â  Â  const authSubmitBtn = document.getElementById('auth-submit-btn');
Â  Â  const authTitle = document.getElementById('auth-title');
Â  Â  const switchToSignupLink = document.getElementById('switch-to-signup');

Â  Â  let isLoginMode = true;

Â  Â  switchToSignupLink.addEventListener('click', (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  isLoginMode = !isLoginMode;
Â  Â  Â  authTitle.textContent = isLoginMode ? 'Login' : 'Sign Up';
Â  Â  Â  authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Sign Up';
Â  Â  Â  switchToSignupLink.textContent = isLoginMode ? 'Sign Up' : 'Login';
Â  Â  Â  const switchText = isLoginMode ? "Don't have an account?" : "Already have an account?";
Â  Â  Â  switchToSignupLink.parentNode.firstChild.nodeValue = switchText + ' ';

Â  Â  Â  authNameInput.style.display = isLoginMode ? 'none' : 'block';
Â  Â  Â  authNameInput.required = !isLoginMode;
Â  Â  });

Â  Â  authForm.addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault();
Â  Â  Â  const email = authEmailInput.value;
Â  Â  Â  const password = authPasswordInput.value;
Â  Â  Â  const name = authNameInput.value;

Â  Â  Â  if (!email || !password || (!isLoginMode && !name)) {
Â  Â  Â  Â  alert("Please enter all required fields (Name, Email, Password).");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  if (isLoginMode) {
Â  Â  Â  Â  loginUser(email, password);
Â  Â  Â  } else {
Â  Â  Â  Â  signupUser(email, password, name);
Â  Â  Â  }
Â  Â  });

Â  Â  function showLoginSignup() {
Â  Â  Â  hideAllSections();
Â  Â  Â  document.getElementById("auth-section").style.display = "block";
Â  Â  Â  isLoginMode = true;
Â  Â  Â  authTitle.textContent = 'Login';
Â  Â  Â  authSubmitBtn.textContent = 'Login';
Â  Â  Â  switchToSignupLink.textContent = 'Sign Up';
Â  Â  Â  switchToSignupLink.parentNode.firstChild.nodeValue = "Don't have an account? ";
Â  Â  Â  authNameInput.style.display = 'none';
Â  Â  Â  authNameInput.required = false;
Â  Â  Â  authForm.reset();
Â  Â  }

Â  Â  async function signupUser(email, password, name) {
Â  Â  Â  try {
Â  Â  Â  Â  const userCredential = await auth.createUserWithEmailAndPassword(email, password);
Â  Â  Â  Â  const user = userCredential.user;

Â  Â  Â  Â  if (user && name) {
Â  Â  Â  Â  Â  Â  await user.updateProfile({ displayName: name });
Â  Â  Â  Â  Â  Â  console.log("User display name set to:", name);
Â  Â  Â  Â  }

Â  Â  Â  Â  alert('Account created successfully! You are now logged in.');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Signup error:", error);
Â  Â  Â  Â  alert(`Signup failed: ${error.message}`);
Â  Â  Â  }
Â  Â  }

Â  Â  async function loginUser(email, password) {
Â  Â  Â  try {
Â  Â  Â  Â  await auth.signInWithEmailAndPassword(email, password);
Â  Â  Â  Â  alert('Logged in successfully!');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Login error:", error);
Â  Â  Â  Â  alert(`Login failed: ${error.message}`);
Â  Â  Â  }
Â  Â  }

Â  Â  async function logoutUser() {
Â  Â  Â  try {
Â  Â  Â  Â  await auth.signOut();
Â  Â  Â  Â  alert('Logged out successfully!');
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Logout error:", error);
Â  Â  Â  Â  alert(`Logout failed: ${error.message}`);
Â  Â  Â  }
Â  Â  }


Â  Â  async function populateInitialData() {
Â  Â  Â  Â  console.log("--- populateInitialData started ---");
Â  Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  Â  console.error("populateInitialData: Firestore database (db) is not initialized. Cannot populate data.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const citiesCollection = db.collection('cities');
Â  Â  Â  Â  const moviesCollection = db.collection('movies');
Â  Â  Â  Â  const theatresCollection = db.collection('theatres');
Â  Â  Â  Â  const showtimesCollection = db.collection('showtimes');

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  console.log("populateInitialData: Checking if 'cities' collection is empty...");
Â  Â  Â  Â  Â  Â  const citySnap = await citiesCollection.limit(1).get();
Â  Â  Â  Â  Â  Â  if (!citySnap.empty) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log("populateInitialData: Data already exists in 'cities' collection. Skipping full population.");
Â  Â  Â  Â  Â  Â  Â  Â  console.log("--- populateInitialData finished (skipped) ---");
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("populateInitialData: Error checking for existing data (likely a READ permission issue on 'cities'):", error);
Â  Â  Â  Â  Â  Â  console.warn("populateInitialData: Proceeding with population attempt assuming collection is empty due to read error.");
Â  Â  Â  Â  }

Â  Â  Â  Â  console.log("populateInitialData: Collections are empty or inaccessible for read. Starting data population.");

Â  Â  Â  Â  const citiesData = [
Â  Â  Â  Â  Â  Â  { id: "hyderabad", name: "Hyderabad" },
Â  Â  Â  Â  Â  Â  { id: "bangalore", name: "Bangalore" },
Â  Â  Â  Â  Â  Â  { id: "chennai", name: "Chennai" },
Â  Â  Â  Â  Â  Â  { id: "mumbai", name: "Mumbai" },
Â  Â  Â  Â  Â  Â  { id: "delhi", name: "Delhi" }
Â  Â  Â  Â  ];

Â  Â  Â  Â  const moviesData = [
Â  Â  Â  Â  Â  Â  { id: "dune-part-two", name: "Dune: Part Two", poster: "images/dune-part-two.jpg" },
Â  Â  Â  Â  Â  Â  { id: "kung-fu-panda-4", name: "Kung Fu Panda 4", poster: "images/kung-fu-panda-4.jpg" },
Â  Â  Â  Â  Â  Â  { id: "godzilla-x-kong", name: "Godzilla x Kong", poster: "images/godzilla-x-kong.jpg" },
Â  Â  Â  Â  Â  Â  { id: "ghostbusters", name: "Ghostbusters: Frozen Empire", poster: "images/ghostbusters.jpeg" },
Â  Â  Â  Â  Â  Â  { id: "challengers", name: "Challengers", poster: "images/challengers.png" },
Â  Â  Â  Â  Â  Â  { id: "civil-war", name: "Civil War", poster: "images/civil-war.jpeg" },
Â  Â  Â  Â  Â  Â  { id: "the-first-omen", name: "The First Omen", poster: "images/the-first-omen.jpeg" },
Â  Â  Â  Â  Â  Â  { id: "monkey-man", name: "Monkey Man", poster: "images/monkey-man.jpg" }
Â  Â  Â  Â  ];

Â  Â  Â  Â  const theatresPreData = [
Â  Â  Â  Â  Â  Â  { id: "pvr-cinemas-hyderabad", name: "PVR Cinemas", city_id: "hyderabad" },
Â  Â  Â  Â  Â  Â  { id: "inox-hyderabad", name: "INOX", city_id: "hyderabad" },
Â  Â  Â  Â  Â  Â  { id: "cinepolis-bangalore", name: "Cinepolis", city_id: "bangalore" },
Â  Â  Â  Â  Â  Â  { id: "prasads-chennai", name: "Prasads", city_id: "chennai" },
Â  Â  Â  Â  Â  Â  { id: "dt-cinemas-mumbai", name: "DT Cinemas", city_id: "mumbai" },
Â  Â  Â  Â  Â  Â  { id: "wave-cinemas-delhi", name: "Wave Cinemas", city_id: "delhi" },
Â  Â  Â  Â  ];

Â  Â  Â  Â  const SEATS_PER_SHOWTIME = 50;

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  console.log("populateInitialData: Attempting to add cities...");
Â  Â  Â  Â  Â  Â  for (const city of citiesData) {
Â  Â  Â  Â  Â  Â  Â  Â  await citiesCollection.doc(city.id).set(city);
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`populateInitialData: Added city: ${city.name}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log("populateInitialData: Cities added. Attempting to add movies...");
Â  Â  Â  Â  Â  Â  for (const movie of moviesData) {
Â  Â  Â  Â  Â  Â  Â  Â  await moviesCollection.doc(movie.id).set(movie);
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`populateInitialData: Added movie: ${movie.name}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log("populateInitialData: Movies added. Attempting to add theatres...");
Â  Â  Â  Â  Â  Â  for (const theatre of theatresPreData) {
Â  Â  Â  Â  Â  Â  Â  Â  await theatresCollection.doc(theatre.id).set(theatre);
Â  Â  Â  Â  Â  Â  Â  Â  console.log(`populateInitialData: Added theatre: ${theatre.name}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  console.log("populateInitialData: Theatres added. Attempting to add showtimes...");

Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "dune-part-two", theatre_id: "pvr-cinemas-hyderabad", screen_name: "Screen 1", time: "10:00 AM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "kung-fu-panda-4", theatre_id: "pvr-cinemas-hyderabad", screen_name: "Screen 3", time: "01:00 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "ghostbusters", theatre_id: "pvr-cinemas-hyderabad", screen_name: "Screen 2", time: "04:00 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "godzilla-x-kong", theatre_id: "inox-hyderabad", screen_name: "Screen 1", time: "11:00 AM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "monkey-man", theatre_id: "inox-hyderabad", screen_name: "Screen 2", time: "02:30 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "challengers", theatre_id: "cinepolis-bangalore", screen_name: "Screen 1", time: "07:00 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "dune-part-two", theatre_id: "cinepolis-bangalore", screen_name: "Screen 2", time: "10:30 AM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "the-first-omen", theatre_id: "prasads-chennai", screen_name: "Screen 1", time: "09:45 AM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "kung-fu-panda-4", theatre_id: "prasads-chennai", screen_name: "Screen 2", time: "01:15 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "civil-war", theatre_id: "dt-cinemas-mumbai", screen_name: "Screen 1", time: "06:00 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  await showtimesCollection.add({
Â  Â  Â  Â  Â  Â  Â  Â  movie_id: "godzilla-x-kong", theatre_id: "wave-cinemas-delhi", screen_name: "Screen 1", time: "09:00 PM", total_seats: SEATS_PER_SHOWTIME, seats: Array.from({ length: SEATS_PER_SHOWTIME }, (_, i) => `Seat ${i + 1}`).reduce((acc, seat) => { acc[seat] = "available"; return acc; }, {})
Â  Â  Â  Â  Â  Â  });


Â  Â  Â  Â  Â  Â  console.log("populateInitialData: All initial data populated successfully!");
Â  Â  Â  Â  Â  Â  console.log("--- populateInitialData finished (success) ---");
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("populateInitialData: CRITICAL ERROR during data population:", error);
Â  Â  Â  Â  Â  Â  console.error("populateInitialData: This means Firestore WRITE Security Rules are blocking the operation.");
Â  Â  Â  Â  Â  Â  console.error("populateInitialData: Ensure 'allow write: if true;' is set for all collections (cities, movies, theatres, showtimes).");
Â  Â  Â  Â  Â  Â  console.log("--- populateInitialData finished (error) ---");
Â  Â  Â  Â  }
Â  Â  }


Â  Â  async function showCities() {
Â  Â  Â  hideAllSections();
Â  Â  Â  document.getElementById("city-section").style.display = "block";

Â  Â  Â  const cityList = document.getElementById("city-list");
Â  Â  Â  cityList.innerHTML = "Loading cities...";

Â  Â  Â  if (!db) {
Â  Â  Â  Â  Â  console.error("Firestore database (db) is not initialized. Cannot fetch cities.");
Â  Â  Â  Â  Â  cityList.innerHTML = "<p style='color:red;'>Firestore not initialized. Check console for Firebase setup errors.</p>";
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const snapshot = await db.collection('cities').get();
Â  Â  Â  Â  cityList.innerHTML = "";
Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  Â  console.warn("No cities found in Firestore 'cities' collection. Is data populated? Check populateInitialData logs.");
Â  Â  Â  Â  Â  Â  cityList.innerHTML = "<p style='text-align:center;'>No cities found. Please ensure data is added to Firestore (check console for errors).</p>";
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  const cityData = doc.data();
Â  Â  Â  Â  Â  if (cityData && cityData.name) {
Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  Â  Â  Â  btn.className = "btn";
Â  Â  Â  Â  Â  Â  Â  btn.textContent = cityData.name;
Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => fetchMovies(doc);
Â  Â  Â  Â  Â  Â  Â  cityList.appendChild(btn);
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  console.warn("Found a city document without a 'name' field:", doc.id, cityData);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log("Cities fetched and displayed successfully.");
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error fetching cities: ", error);
Â  Â  Â  Â  console.error("Possible reasons: Firebase config incorrect, Firestore not enabled, or Security Rules blocking read access.");
Â  Â  Â  Â  cityList.innerHTML = "<p style='text-align:center; color:red;'>Error loading cities. Please check browser console and Firebase setup.</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  async function fetchMovies(cityDoc) {
Â  Â  Â  selectedCityDocRef = cityDoc;
Â  Â  Â  hideAllSections();
Â  Â  Â  document.getElementById("movie-list").style.display = "block";

Â  Â  Â  const movieGrid = document.getElementById("movie-grid");
Â  Â  Â  movieGrid.innerHTML = "Loading movies...";

Â  Â  Â  if (!db) { console.error("Firestore not initialized."); movieGrid.innerHTML = "<p style='text-align:center; color:red;'>Firestore not initialized.</p>"; return; }

Â  Â  Â  try {
Â  Â  Â  Â  const movieSnapshot = await db.collection('movies').get();
Â  Â  Â  Â  const theatreSnapshot = await db.collection('theatres').where('city_id', '==', selectedCityDocRef.id).get();
Â  Â  Â  Â  const showtimeSnapshot = await db.collection('showtimes').get();

Â  Â  Â  Â  const availableMovieIdsInCity = new Set();
Â  Â  Â  Â  theatreSnapshot.forEach(theatreDoc => {
Â  Â  Â  Â  Â  Â  const theatreId = theatreDoc.id;
Â  Â  Â  Â  Â  Â  showtimeSnapshot.forEach(showtimeDoc => {
Â  Â  Â  Â  Â  Â  Â  Â  if (showtimeDoc.data().theatre_id === theatreId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  availableMovieIdsInCity.add(showtimeDoc.data().movie_id);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  movieGrid.innerHTML = "";
Â  Â  Â  Â  let moviesFound = false;
Â  Â  Â  Â  movieSnapshot.forEach(movieDoc => {
Â  Â  Â  Â  Â  Â  if (availableMovieIdsInCity.has(movieDoc.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  moviesFound = true;
Â  Â  Â  Â  Â  Â  Â  Â  const movieData = movieDoc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const movieCard = document.createElement("div");
Â  Â  Â  Â  Â  Â  Â  Â  movieCard.className = "movie-card";
Â  Â  Â  Â  Â  Â  Â  Â  movieCard.onclick = () => fetchTheatres(movieDoc);

Â  Â  Â  Â  Â  Â  Â  Â  const img = document.createElement("img");
Â  Â  Â  Â  Â  Â  Â  Â  img.src = movieData.poster;
Â  Â  Â  Â  Â  Â  Â  Â  img.alt = movieData.name + " Poster";
Â  Â  Â  Â  Â  Â  Â  Â  img.onerror = function() { this.onerror=null; this.src='https://placehold.co/150x225/CCCCCC/000000?text=Image+Missing'; };

Â  Â  Â  Â  Â  Â  Â  Â  const title = document.createElement("h3");
Â  Â  Â  Â  Â  Â  Â  Â  title.textContent = movieData.name;

Â  Â  Â  Â  Â  Â  Â  Â  movieCard.appendChild(img);
Â  Â  Â  Â  Â  Â  Â  Â  movieGrid.appendChild(movieCard);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!moviesFound) {
Â  Â  Â  Â  Â  Â  movieGrid.innerHTML = "<p style='text-align:center;'>No movies found for this city.</p>";
Â  Â  Â  Â  }
Â  Â  Â  Â  console.log("Movies fetched and displayed.");

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error fetching movies: ", error);
Â  Â  Â  Â  movieGrid.innerHTML = "<p style='text-align:center; color:red;'>Error loading movies. Please try again.</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  async function fetchTheatres(movieDoc) {
Â  Â  Â  selectedMovieDocRef = movieDoc;
Â  Â  Â  hideAllSections();
Â  Â  Â  document.getElementById("theatre-selection").style.display = "block";

Â  Â  Â  const theatreButtons = document.getElementById("theatre-buttons");
Â  Â  Â  theatreButtons.innerHTML = "Loading theatres...";

Â  Â  Â  if (!db) { console.error("Firestore not initialized."); theatreButtons.innerHTML = "<p style='text-align:center; color:red;'>Firestore not initialized.</p>"; return; }

Â  Â  Â  try {
Â  Â  Â  Â  const theatreQuery = db.collection('theatres').where('city_id', '==', selectedCityDocRef.id);
Â  Â  Â  Â  const theatreSnapshot = await theatreQuery.get();

Â  Â  Â  Â  const theatresForMovie = new Set();
Â  Â  Â  Â  const showtimeQuery = db.collection('showtimes').where('movie_id', '==', selectedMovieDocRef.id);
Â  Â  Â  Â  const showtimeSnapshot = await showtimeQuery.get();

Â  Â  Â  Â  showtimeSnapshot.forEach(showtimeDoc => {
Â  Â  Â  Â  Â  Â  theatresForMovie.add(showtimeDoc.data().theatre_id);
Â  Â  Â  Â  });

Â  Â  Â  Â  theatreButtons.innerHTML = "";
Â  Â  Â  Â  let theatresFound = false;
Â  Â  Â  Â  theatreSnapshot.forEach(theatreDoc => {
Â  Â  Â  Â  Â  Â  if (theatresForMovie.has(theatreDoc.id)) {
Â  Â  Â  Â  Â  Â  Â  Â  theatresFound = true;
Â  Â  Â  Â  Â  Â  Â  Â  const theatreData = theatreDoc.data();
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  Â  Â  Â  Â  btn.className = "btn";
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = theatreData.name;
Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => fetchShowtimes(theatreDoc, selectedMovieDocRef);
Â  Â  Â  Â  Â  Â  Â  Â  theatreButtons.appendChild(btn);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  if (!theatresFound) {
Â  Â  Â  Â  Â  Â  theatreButtons.innerHTML = "<p style='text-align:center;'>No theatres found for this movie in your selected city.</p>";
Â  Â  Â  Â  }
Â  Â  Â  Â  console.log("Theatres fetched and displayed.");

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error fetching theatres: ", error);
Â  Â  Â  Â  theatreButtons.innerHTML = "<p style='text-align:center; color:red;'>Error loading theatres. Please try again.</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  async function fetchShowtimes(theatreDoc, movieDoc) {
Â  Â  Â  selectedTheatreDocRef = theatreDoc;
Â  Â  Â  selectedMovieDocRef = movieDoc;
Â  Â  Â  hideAllSections();
Â  Â  Â  document.getElementById("screen-list").style.display = "block";

Â  Â  Â  const screenButtons = document.getElementById("screen-buttons");
Â  Â  Â  screenButtons.innerHTML = "Loading showtimes...";

Â  Â  Â  if (!db) { console.error("Firestore not initialized."); screenButtons.innerHTML = "<p style='text-align:center; color:red;'>Firestore not initialized.</p>"; return; }

Â  Â  Â  try {
Â  Â  Â  Â  const showtimeQuery = db.collection('showtimes')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .where('theatre_id', '==', theatreDoc.id)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .where('movie_id', '==', movieDoc.id)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .orderBy('time');

Â  Â  Â  Â  const snapshot = await showtimeQuery.get();

Â  Â  Â  Â  screenButtons.innerHTML = "";
Â  Â  Â  Â  if (snapshot.empty) {
Â  Â  Â  Â  Â  screenButtons.innerHTML = "<p style='text-align:center;'>No showtimes available for this movie at this theatre.</p>";
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  Â  const showtimeData = doc.data();
Â  Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  Â  btn.className = "btn";
Â  Â  Â  Â  Â  btn.textContent = `${showtimeData.screen_name} - ${showtimeData.time}`;
Â  Â  Â  Â  Â  btn.onclick = () => selectScreen(doc);
Â  Â  Â  Â  Â  screenButtons.appendChild(btn);
Â  Â  Â  Â  });
Â  Â  Â  Â  console.log("Showtimes fetched and displayed.");

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error fetching showtimes: ", error);
Â  Â  Â  Â  screenButtons.innerHTML = "<p style='text-align:center; color:red;'>Error loading showtimes. Please try again.</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  async function selectScreen(showtimeDoc) {
Â  Â  Â  selectedShowtimeDoc = showtimeDoc;
Â  Â  Â  hideAllSections();
Â  Â  Â  document.getElementById("seat-selection").style.display = "block";

Â  Â  Â  const seatButtons = document.getElementById("seat-buttons");
Â  Â  Â  seatButtons.innerHTML = "Loading seats...";
Â  Â  Â  selectedSeats = [];
Â  Â  Â  document.getElementById("total-amount-display").textContent = `Total Amount: â‚¹${0}`;

Â  Â  Â  if (!db) { console.error("Firestore not initialized."); seatButtons.innerHTML = "<p style='text-align:center; color:red;'>Firestore not initialized.</p>"; return; }

Â  Â  Â  try {
Â  Â  Â  Â  db.collection('showtimes').doc(selectedShowtimeDoc.id)
Â  Â  Â  Â  Â  .onSnapshot(docSnapshot => {
Â  Â  Â  Â  Â  Â  if (docSnapshot.exists) {
Â  Â  Â  Â  Â  Â  Â  const showtimeData = docSnapshot.data();
Â  Â  Â  Â  Â  Â  Â  const seatsStatus = showtimeData.seats || {};

Â  Â  Â  Â  Â  Â  Â  seatButtons.innerHTML = "";
Â  Â  Â  Â  Â  Â  Â  const totalSeats = showtimeData.total_seats || 50;

Â  Â  Â  Â  Â  Â  Â  for (let i = 1; i <= totalSeats; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const seatNum = `Seat ${i}`;
Â  Â  Â  Â  Â  Â  Â  Â  const status = seatsStatus[seatNum] || 'available';

Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement("button");
Â  Â  Â  Â  Â  Â  Â  Â  btn.className = "btn";
Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = seatNum;

Â  Â  Â  Â  Â  Â  Â  Â  if (status === 'booked') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('booked-seat');
Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (status === 'pending') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('pending-seat');
Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => toggleSeat(btn, seatNum);
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (selectedSeats.includes(seatNum)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('selected-seat');
Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  seatButtons.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  console.log("Seats updated from Firestore.");
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  seatButtons.innerHTML = "<p style='text-align:center; color:red;'>Showtime not found or deleted.</p>";
Â  Â  Â  Â  Â  Â  Â  console.error("Showtime document not found:", selectedShowtimeDoc.id);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }, error => {
Â  Â  Â  Â  Â  Â  console.error("Error listening to seats:", error);
Â  Â  Â  Â  Â  Â  seatButtons.innerHTML = "<p style='text-align:center; color:red;'>Error loading seats in real-time. Please check console.</p>";
Â  Â  Â  Â  Â  });

Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error preparing seat selection:", error);
Â  Â  Â  Â  seatButtons.innerHTML = "<p style='text-align:center; color:red;'>Error preparing seats. Please try again.</p>";
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Toggles the selection of a seat and updates the UI and total amount.
Â  Â  Â * @param {HTMLButtonElement} button - The seat button element.
Â  Â  Â * @param {string} seatNum - The seat number (e.g., "Seat 5").
Â  Â  Â */
Â  Â  function toggleSeat(button, seatNum) {
Â  Â  Â  const index = selectedSeats.indexOf(seatNum);

Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  selectedSeats.splice(index, 1);
Â  Â  Â  Â  button.classList.remove("selected-seat");
Â  Â  Â  } else {
Â  Â  Â  Â  selectedSeats.push(seatNum);
Â  Â  Â  Â  button.classList.add("selected-seat");
Â  Â  Â  }
Â  Â  Â  document.getElementById("total-amount-display").textContent = `Total Amount: â‚¹${selectedSeats.length * seatPrice}`;
Â  Â  Â  console.log("Selected seats:", selectedSeats);
Â  Â  }

Â  Â  /**
Â  Â  Â * Proceeds from seat selection to the payment section.
Â  Â  Â * Attempts to temporarily block selected seats in Firestore.
Â  Â  Â */
Â  Â  async function goToPayment() {
Â  Â  Â  if (selectedSeats.length === 0) {
Â  Â  Â  Â  alert("Please select at least one seat before proceeding to payment.");
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  alert("Please log in to proceed with booking.");
Â  Â  Â  Â  showLoginSignup();
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  const showtimeRef = db.collection('showtimes').doc(selectedShowtimeDoc.id);
Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  selectedSeats.forEach(seat => {
Â  Â  Â  Â  Â  updates[`seats.${seat}`] = "pending";
Â  Â  Â  Â  });

Â  Â  Â  Â  await showtimeRef.update(updates);

Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  document.getElementById("payment-section").style.display = "block";
Â  Â  Â  Â  document.getElementById("payment-total-amount").textContent = `Total Amount: â‚¹${selectedSeats.length * seatPrice}`;
Â  Â  Â  Â  console.log("Seats successfully set to 'pending' in Firestore.");
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error("Error blocking seats:", error);
Â  Â  Â  Â  alert("Failed to block seats. They might have been taken or an error occurred. Please re-select your seats.");
Â  Â  Â  Â  selectScreen(selectedShowtimeDoc);
Â  Â  Â  }
Â  Â  }

Â  Â  /**
Â  Â  Â * Confirms the booking, finalizes seat status to 'booked' in Firestore,
Â  Â  Â * and records the booking.
Â  Â  Â */
Â  Â  async function confirmBooking() {
Â  Â  Â  Â  if (selectedSeats.length === 0) {
Â  Â  Â  Â  Â  Â  alert("No seats selected for booking.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!currentUser) {
Â  Â  Â  Â  Â  Â  alert("You must be logged in to confirm a booking.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const showtimeRef = db.collection('showtimes').doc(selectedShowtimeDoc.id);

Â  Â  Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  const showtimeDoc = await transaction.get(showtimeRef);
Â  Â  Â  Â  Â  Â  Â  Â  if (!showtimeDoc.exists) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Showtime does not exist!");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const currentSeatsStatus = showtimeDoc.data().seats || {};
Â  Â  Â  Â  Â  Â  Â  Â  const updates = {};
Â  Â  Â  Â  Â  Â  Â  Â  const seatsToBook = [];

Â  Â  Â  Â  Â  Â  Â  Â  selectedSeats.forEach(seat => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (currentSeatsStatus[seat] === 'pending' || currentSeatsStatus[seat] === 'available') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updates[`seats.${seat}`] = "booked";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seatsToBook.push(seat);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Seat ${seat} is no longer available (status: ${currentSeatsStatus[seat] || 'undefined'}).`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (seatsToBook.length !== selectedSeats.length) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Mismatch in selected seats during booking. Some seats might have been taken.");
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  transaction.update(showtimeRef, updates);

Â  Â  Â  Â  Â  Â  Â  Â  transaction.set(db.collection('bookings').doc(), {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_id: currentUser.uid,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  user_email: currentUser.email,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  movie_name: selectedMovieDocRef.data().name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  movie_poster: selectedMovieDocRef.data().poster,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  theatre_name: selectedTheatreDocRef.data().name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  screen_name: selectedShowtimeDoc.data().screen_name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  show_time: selectedShowtimeDoc.data().time,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  seats_booked: seatsToBook,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  total_amount: seatsToBook.length * seatPrice,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  booking_date: firebase.firestore.FieldValue.serverTimestamp(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  status: "confirmed"
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  hideAllSections();
Â  Â  Â  Â  Â  Â  document.getElementById("confirmation").style.display = "block";

Â  Â  Â  Â  Â  Â  const bookingDetails = document.getElementById("booking-details");
Â  Â  Â  Â  Â  Â  bookingDetails.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="movie-poster-details">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${selectedMovieDocRef.data().poster}" alt="${selectedMovieDocRef.data().name} Poster" class="booking-poster">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="booking-details-text">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3>${selectedMovieDocRef.data().name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Theatre:</strong> ${selectedTheatreDocRef.data().name}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Screen & Time:</strong> ${selectedShowtimeDoc.data().screen_name} - ${selectedShowtimeDoc.data().time}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Seats:</strong> ${selectedSeats.join(', ')}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Total Paid:</strong> â‚¹${selectedSeats.length * seatPrice}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  bookingListDiv.appendChild(bookingItem);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  console.log("Booking history fetched for user:", currentUser.email);

Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Error fetching booking history:", error);
Â  Â  Â  Â  Â  Â  bookingListDiv.innerHTML = "<p style='text-align:center; color:red;'>Error loading booking history. Please try again.</p>";
Â  Â  Â  Â  Â  Â  alert("Failed to load booking history: " + error.message);
Â  Â  Â  Â  }
Â  Â  }


Â  Â  window.onload = async () => {
Â  Â  Â  Â  if (typeof firebase !== 'undefined' && firebase.firestore && db && auth) {
Â  Â  Â  Â  Â  Â  await populateInitialData();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  console.error("Firebase SDK not fully loaded or initialized. 'db' or 'auth' object is not available.");
Â  Â  Â  Â  Â  Â  document.getElementById("city-list").innerHTML = "<p style='color:red;'>Firebase SDK failed to load. Check your internet connection and console for errors.</p>";
Â  Â  Â  Â  }
Â  Â  };
Â  </script>
</body>
</html>